# Orchestrator Deployment - Coordinates AlphaZero training iterations
#
# The orchestrator runs the synchronized training loop:
# 1. Clears replay buffer
# 2. Scales up actor deployment
# 3. Waits for N episodes to complete
# 4. Scales down actors (or pauses them)
# 5. Creates trainer Job and waits for completion
# 6. Runs evaluation
# 7. Repeats
#
# This is a singleton - only one orchestrator should run at a time.
# Uses a Deployment with replicas: 1 for automatic restart on failure.
#
apiVersion: apps/v1
kind: Deployment
metadata:
  name: orchestrator
  namespace: cartridge
  labels:
    app.kubernetes.io/name: cartridge
    app.kubernetes.io/component: orchestrator
spec:
  replicas: 1
  strategy:
    type: Recreate  # Don't run multiple orchestrators
  selector:
    matchLabels:
      app.kubernetes.io/name: cartridge
      app.kubernetes.io/component: orchestrator
  template:
    metadata:
      labels:
        app.kubernetes.io/name: cartridge
        app.kubernetes.io/component: orchestrator
    spec:
      serviceAccountName: orchestrator
      containers:
        - name: orchestrator
          image: cartridge/trainer:latest
          imagePullPolicy: IfNotPresent
          command:
            - python
            - -m
            - trainer
            - loop
          args:
            - "--iterations"
            - "$(ITERATIONS)"
            - "--episodes"
            - "$(EPISODES_PER_ITERATION)"
            - "--steps"
            - "$(STEPS_PER_ITERATION)"
            # K8s mode: orchestrator manages actor scaling
            - "--k8s-mode"
          env:
            - name: ITERATIONS
              value: "100"
            - name: EPISODES_PER_ITERATION
              value: "500"
            - name: STEPS_PER_ITERATION
              value: "1000"
            - name: CARTRIDGE_COMMON_DATA_DIR
              value: "/data"
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
          volumeMounts:
            - name: data
              mountPath: /data
            - name: config
              mountPath: /app/config.toml
              subPath: config.toml
              readOnly: true
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: cartridge-data
        - name: config
          configMap:
            name: cartridge-config
---
# ServiceAccount for orchestrator to manage k8s resources
apiVersion: v1
kind: ServiceAccount
metadata:
  name: orchestrator
  namespace: cartridge
---
# Role for orchestrator to manage actor scaling and jobs
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: orchestrator
  namespace: cartridge
rules:
  # Scale actor deployment
  - apiGroups: ["apps"]
    resources: ["deployments", "deployments/scale"]
    verbs: ["get", "list", "watch", "update", "patch"]
  # Create and monitor trainer jobs
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["get", "list", "watch", "create", "delete"]
  # Read pods for status
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
  # Read configmaps
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: orchestrator
  namespace: cartridge
subjects:
  - kind: ServiceAccount
    name: orchestrator
    namespace: cartridge
roleRef:
  kind: Role
  name: orchestrator
  apiGroup: rbac.authorization.k8s.io
