# MinIO Setup Job
# Creates the bucket on first deployment
apiVersion: batch/v1
kind: Job
metadata:
  name: minio-setup
  namespace: cartridge
  labels:
    app.kubernetes.io/name: minio-setup
    app.kubernetes.io/component: storage
    app.kubernetes.io/part-of: cartridge2
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 5
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        # Wait for MinIO to be ready
        - name: wait-for-minio
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for MinIO to be ready..."
              until wget -q --spider http://minio:9000/minio/health/ready; do
                echo "MinIO not ready, waiting..."
                sleep 2
              done
              echo "MinIO is ready!"
      containers:
        - name: mc
          image: minio/mc:RELEASE.2024-11-05T11-29-45Z
          env:
            - name: MINIO_ROOT_USER
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: MINIO_ROOT_USER
            - name: MINIO_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: MINIO_ROOT_PASSWORD
          command:
            - sh
            - -c
            - |
              set -e
              echo "Configuring MinIO client..."
              mc alias set cartridge http://minio:9000 "$MINIO_ROOT_USER" "$MINIO_ROOT_PASSWORD"

              echo "Creating bucket..."
              mc mb cartridge/cartridge-models --ignore-existing

              echo "Setting bucket policy to allow downloads..."
              mc anonymous set download cartridge/cartridge-models

              echo "MinIO setup complete!"
              mc ls cartridge/
