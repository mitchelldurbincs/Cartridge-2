# Cartridge2 Docker Compose Configuration
#
# Configuration:
#   All settings are loaded from config.toml (mounted to /app/config.toml).
#   Environment variables can override config.toml values for quick customization.
#
# Services:
#   - alphazero:  Synchronized AlphaZero training (RECOMMENDED)
#   - evaluator:  Periodic model evaluation against random baseline
#   - actor:      Standalone self-play (for continuous training)
#   - trainer:    Standalone training (for continuous training)
#   - web:        Backend API server
#   - frontend:   Nginx serving Svelte frontend
#
# Shared volume: ./data (SQLite DB, ONNX models, stats.json)
#
# Quick Start:
#   # Train a model (uses settings from config.toml)
#   docker compose up alphazero
#
#   # Override specific settings via environment variables
#   CARTRIDGE_COMMON_ENV_ID=connect4 docker compose up alphazero
#
#   # Legacy environment variables still work for backward compatibility
#   ALPHAZERO_ENV_ID=connect4 docker compose up alphazero
#
#   # Play against the trained model
#   docker compose up web frontend
#   # Open http://localhost in browser
#
#   # Run standalone evaluation
#   docker compose run --rm evaluator
#
#   # Watch training progress
#   docker compose logs -f alphazero

services:
  # ==========================================================================
  # AlphaZero - Synchronized Training (RECOMMENDED)
  # ==========================================================================
  # Each iteration: clear buffer -> generate episodes -> train -> evaluate
  # This ensures training data comes from the current model only
  #
  # Settings loaded from config.toml. Override with environment variables:
  #   CARTRIDGE_COMMON_ENV_ID, CARTRIDGE_TRAINING_ITERATIONS, etc.
  #   Legacy ALPHAZERO_* variables also supported for backward compatibility.
  alphazero:
    build:
      context: .
      dockerfile: Dockerfile.alphazero
    container_name: cartridge-alphazero
    profiles:
      - local
    volumes:
      - ./data:/app/data
      - ./config.toml:/app/config.toml:ro
    environment:
      # Legacy env vars for backward compatibility (override config.toml)
      - ALPHAZERO_ENV_ID=${ALPHAZERO_ENV_ID:-}
      - ALPHAZERO_ITERATIONS=${ALPHAZERO_ITERATIONS:-}
      - ALPHAZERO_EPISODES=${ALPHAZERO_EPISODES:-}
      - ALPHAZERO_STEPS=${ALPHAZERO_STEPS:-}
      - ALPHAZERO_DEVICE=${ALPHAZERO_DEVICE:-}
      - ALPHAZERO_EVAL_INTERVAL=${ALPHAZERO_EVAL_INTERVAL:-}
      - ALPHAZERO_EVAL_GAMES=${ALPHAZERO_EVAL_GAMES:-}
    networks:
      - cartridge-net

  # ==========================================================================
  # Evaluator - Standalone Model Evaluation
  # ==========================================================================
  # Evaluates the latest model against random baseline
  # Can be run as a one-shot or on a schedule
  evaluator:
    build:
      context: trainer
      dockerfile: Dockerfile
    container_name: cartridge-evaluator
    profiles:
      - tools
    volumes:
      - ./data:/app/data
      - ./config.toml:/app/config.toml:ro
    entrypoint: ["python", "-m", "trainer", "evaluate"]
    command:
      - "--model=/app/data/models/latest.onnx"
      - "--db=/app/data/replay.db"
    networks:
      - cartridge-net

  # ==========================================================================
  # Actor - Standalone Self-Play (continuous mode)
  # ==========================================================================
  # Generates self-play episodes independently
  # Use for continuous/async training setups
  # Settings loaded from config.toml
  actor:
    build:
      context: .
      dockerfile: actor/Dockerfile
    container_name: cartridge-actor
    profiles:
      - continuous
    restart: unless-stopped
    volumes:
      - ./data:/app/data
      - ./config.toml:/app/config.toml:ro
    networks:
      - cartridge-net

  # ==========================================================================
  # Trainer - Standalone Training (continuous mode)
  # ==========================================================================
  # Trains on replay buffer data independently
  # Use for continuous/async training setups
  # Settings loaded from config.toml
  trainer:
    build:
      context: trainer
      dockerfile: Dockerfile
    container_name: cartridge-trainer
    profiles:
      - continuous
    restart: unless-stopped
    volumes:
      - ./data:/app/data
      - ./config.toml:/app/config.toml:ro
    entrypoint: ["python", "-m", "trainer", "train"]
    networks:
      - cartridge-net

  # ==========================================================================
  # Web Backend - API server with game logic
  # ==========================================================================
  # Settings loaded from config.toml
  web:
    build:
      context: .
      dockerfile: web/Dockerfile
    container_name: cartridge-web
    profiles:
      - local
    restart: unless-stopped
    volumes:
      - ./data:/app/data
      - ./config.toml:/app/config.toml:ro
    environment:
      - RUST_LOG=info
    ports:
      - "8080:8080"
    networks:
      - cartridge-net

  # ==========================================================================
  # Frontend - Nginx serving Svelte app + proxying API
  # ==========================================================================
  frontend:
    build:
      context: web/frontend
      dockerfile: Dockerfile
    container_name: cartridge-frontend
    profiles:
      - local
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - web
    networks:
      - cartridge-net

networks:
  cartridge-net:
    driver: bridge

volumes:
  data:
    driver: local
