# Cartridge2 Docker Compose Configuration
#
# Services:
#   - alphazero:  Synchronized AlphaZero training (actor + trainer in one container)
#   - web:        Backend API server for playing against trained models
#   - frontend:   Nginx serving Svelte frontend
#
# Shared volume: ./data (SQLite DB, ONNX models, stats.json)
#
# Quick Start:
#   # Train a model (uses settings from config.toml)
#   docker compose up alphazero
#
#   # Override game via environment variable
#   CARTRIDGE_COMMON_ENV_ID=connect4 docker compose up alphazero
#
#   # Play against the trained model
#   docker compose up web frontend
#   # Open http://localhost in browser
#
#   # Run standalone evaluation
#   docker compose run --rm alphazero python -m trainer evaluate --model /app/data/models/latest.onnx
#
#   # Watch training progress
#   docker compose logs -f alphazero
#
# For K8s backend testing (PostgreSQL + MinIO):
#   docker compose -f docker-compose.yml -f docker-compose.k8s.yml up alphazero

services:
  # ==========================================================================
  # AlphaZero - Synchronized Training
  # ==========================================================================
  # Each iteration: clear buffer -> generate episodes -> train -> evaluate
  # This ensures training data comes from the current model only.
  #
  # All settings loaded from config.toml. Override with environment variables:
  #   CARTRIDGE_COMMON_ENV_ID, CARTRIDGE_TRAINING_ITERATIONS, etc.
  alphazero:
    build:
      context: .
      dockerfile: Dockerfile.alphazero
    volumes:
      - ./data:/app/data
      - ./config.toml:/app/config.toml:ro
    environment:
      # Pass through environment overrides (empty = use config.toml defaults)
      - CARTRIDGE_COMMON_ENV_ID=${CARTRIDGE_COMMON_ENV_ID:-}
      - CARTRIDGE_TRAINING_ITERATIONS=${CARTRIDGE_TRAINING_ITERATIONS:-}
      - CARTRIDGE_TRAINING_EPISODES_PER_ITERATION=${CARTRIDGE_TRAINING_EPISODES_PER_ITERATION:-}
      - CARTRIDGE_TRAINING_STEPS_PER_ITERATION=${CARTRIDGE_TRAINING_STEPS_PER_ITERATION:-}
      - CARTRIDGE_TRAINING_DEVICE=${CARTRIDGE_TRAINING_DEVICE:-}
      - CARTRIDGE_EVALUATION_INTERVAL=${CARTRIDGE_EVALUATION_INTERVAL:-}
      - CARTRIDGE_EVALUATION_GAMES=${CARTRIDGE_EVALUATION_GAMES:-}
    networks:
      - cartridge-net

  # ==========================================================================
  # Web Backend - API server with game logic
  # ==========================================================================
  web:
    build:
      context: .
      dockerfile: web/Dockerfile
    restart: unless-stopped
    volumes:
      - ./data:/app/data
      - ./config.toml:/app/config.toml:ro
    environment:
      - RUST_LOG=info
    ports:
      - "8080:8080"
    networks:
      - cartridge-net

  # ==========================================================================
  # Frontend - Nginx serving Svelte app + proxying API
  # ==========================================================================
  frontend:
    build:
      context: web/frontend
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "80:8080"
    depends_on:
      - web
    networks:
      - cartridge-net

networks:
  cartridge-net:
    driver: bridge
